# 第一章--TCP/IP协议族

## TCP / IP 协议族体系结构以及主要协议

*TCP / IP协议族是一个四层协议系统 :*

-  **数据链路层**
- **网络层**
- **传输层**
- **应用层**

*每一层完成相应的功能, 并且通过若干协议实现, **上层协议使用下层协议提供的服务***

![Screenshot_2022-09-03-19-59-06-755_com.miui.gallery](D:\Download\MiShare\Screenshot_2022-09-03-19-59-06-755_com.miui.gallery.png)



### 数据链路层

- **实现了网卡接口的网络驱动程序, 以处理数据在物理媒介上的传输**

  >  *物理媒介 : 以太网, 令牌环等...*

  ***不同的物理网络具有不同的电气特性, 网络驱动程序隐藏了这些细节, 为上层协议提供了一个统一的接口***

  

- 数据链路层的常用协议

  - **APR协议 (Address Resolve Prosolve, 地址解析协议)**

  - **RARP协议 (Reverse Address Resolve Protocol, 逆地址解析协议)**

  *这两种协议实现了**IP地址和机器物理地址 ( 通常为MAC地址)**的相互转换*



---

### 网络层

- **实现数据包的选路和转发**

  > ​	*WAN (Wide Area NetWork 广域网)通常使用众多分级的路由器来连接分散的主机和LAN (Local Area Network 局域网), 因此, 通信的两台主机一般不是直接相连的, 而是通过多个中间节点 (路由器) 连接的.*
  >
  > ***网络层的任务就是选择这些中间系欸按, 以确定两台主机之间的通信路径***

  **网络层对上层协议隐藏了网络拓扑连接的细节, 使得传输层和网络应用程序看来, 通信的双方是直接相连的**

  

- *核心协议*

  - ##### IP协议(Internet Protocol, 因特网协议)

    >  IP协议根据数据包的目的IP地址来决定如何投递它
    >
    > 如果数据包不能直接发送给目标主机, 那么IP协议就为它寻找一个合适的下一条路由器, 并将数据包交给该路由器转发, 然后重复这一过程

  - ##### ICMP协议 (Internet Control Message Protocol, 因特网控制报文协议)

    *该协议是IP协议的重要补充*

    **主要用于检测网络连接**



---

### 传输层

- ##### 为两台主机上的应用程序提供端到端的通信

  *传输层只关心通信的起始端和目的端, 不在乎数据包的传输过程*



- *主要协议*

  - **TCP协议**

    *为应用层提供给可靠的, 面向连接的和基于流的服务*

    使用超时重传, 数据确认等方式来确保数据包被正确的发送到目的端

    

  - **UDP协议**

    *为应用层提供不可靠的, 无连接和基于数据报的服务*

    数据在传输过程中丢失, 或者目的端通过数据校验发现数据错误而丢弃, UDP仅通知应用程序发送失败

    

  - **SCTO协议**
    *一种相对较新的传输层协议, 为了因特网上传输电话信号而设计*



---

### 应用层

- **负责处理应用程序的逻辑**

  *与数据链路层, 网络层, 传输层不同, 应用层在用户空间实现, 因为它负责众多逻辑*

  如 : 文件传输, 名称查询和网络管理...等等

  

- *协议举例*

  - **telnet协议**

    一种远程登录协议, 

    

  - **OSPF (Open Shortest Path Fisrst, 开放最短路径优先)协议**

    *一种动态路由更新协议, 用于路由器之间的通信, 以告知对方各自的信息*

    

  - **DNS (Domain Name Service 域名服务)协议**

    *提供机器域名到IP地址的转换*

  

- *应用层协议(或程序) 可能跳过传输层直接使用网络层提供的服务*

  如 : Ping 程序和OSPF协议

  

- *通常既可以使用TCP服务, 又可以使用UDP服务*

  如 : DNS协议



---

## 封装

*下层协议将接口封装, 供给上层协议调用*

**应用数据发送到网络前, 将沿着协议从上到下依次传递, 每层协议都将在上层数据的基础上加上自己的头部信息 (有时还有尾部信息), 以实现该层的功能, 这个过程就叫封装**



### 数据报

![Screenshot_2022-09-03-21-14-42-016_com.miui.gallery](D:\Download\MiShare\Screenshot_2022-09-03-21-14-42-016_com.miui.gallery.png)



- 经过TCP封装, 形成**TCP报文段**

  *TCP报文段包含TCP头部信息, TCP内核缓冲区*

  ![Screenshot_2022-09-03-21-17-01-579_com.miui.gallery](D:\Download\MiShare\Screenshot_2022-09-03-21-17-01-579_com.miui.gallery.png)

  >  	当发送端应用程序使用 send（或者 write）函数向一个TCP连接写入数据时
  >
  > - 内核中的TCP模块首先把这些数据复制到与该连接对应的TCP内核发送缓冲区中
  > - TCP模块调用IP模块提供的服务，传递的参数包括TCP头部信息和TCP发送缓冲区中的数据，即TCP报文段。



- 经过UDP封装, 形成**UDP数据报**

  *与TCP不同, UDP传输数据后, 无需为应用层数据保存副本*

  

- 经过IP封装, 形成**IP数据报**

  *IP数据报也包含头部部分和数据部分, 数据部分就是一个TCP报文段, UDP数据报或者ICMP报文*



---

### 帧

*经过数据链路层封装的数据称为帧*

媒介不同, 帧的类型也不同

- 以太网帧
- 令牌环帧



帧的最大传输单元(**MTU**), 规定帧最多能携带多少**上层协议数据**



---

## 分用

*当帧到达目的主机时, 将沿着协议栈自底向上依次传递*

> 信息发送时, 沿着协议栈自上向下传递,相当于对信息进行包装, 
>
> 接收时, 沿着协议栈自底向上传递, 相当于对信息拆包



![Screenshot_2022-09-03-21-31-35-642_com.miui.gallery](D:\Download\MiShare\Screenshot_2022-09-03-21-31-35-642_com.miui.gallery.png)

- **由于IP协议, ARP协议和RARP协议都是用帧传输, 所以帧头部需要加上标识字段来区分他们**

  具体情况取决于帧的类型

  > 以以太网帧为例，它使用2字节的类型字段来标识上层协议
  >
  > 如果主机接收到的以太网帧类型字段的值为0x800，则帧的数据部分为IP数据报，以太网驱动程序就将帧交付给IP模块；
  >
  > 若类型字段的值为0x806，则帧的数据部分为ARP请求或应答报文，以太网驱动程序就将帧交付给ARP模块；若类型字段的值为0x835，则帧的数据部分为RARP请求或应答报文，以太网驱动程序就将帧交付给RARP模块。

  ![a](D:\Download\MiShare\a.jpg)

  

- **同样, 因为ICMP, TCP, UCP协议都是用IP协议, 所以IP数据报在头部使用了16位来区分他们**

> TCP报文段和UDP数据报则通过其头部中的16位的端口号（port number）字段来区分上层应用程序。
>
> 比如DNS协议对应的端口号是53，HTTP协议(Hyper-Text Transfer Protocol，超文本传送协议）对应的端口号是80。



---

## ARP协议工作原理

### 以太网APR请求 / 应答报文详解

![Screenshot_2022-09-03-21-42-31-888_com.miui.gallery](D:\Download\MiShare\Screenshot_2022-09-03-21-42-31-888_com.miui.gallery.png)

- **硬件类型字段定义物理地址的类型**

  它的值为1表示MAC地址。

  

- **协议类型字段表示要映射的协议地址类型**

  它的值为0x800，表示IP地址。

  

- **硬件地址长度字段和协议地址长度字段**

  顾名思义，其单位是字节。

  对MAC地址来说，其长度为6；

  对IP（v4）地址来说，其长度为4。

  

- **操作字段指出4种操作类型：**

  - ARP请求  （值为1）
  - ARP应答  （值为2）
  - RARP请求（值为3)
  - RARP应答（值为4）

  

- **最后4个字段指定通信双方的以太网地址和IP地址。**

  - 发送端填充除目的端以太网地址外的其他3个字段，以构建ARP请求并发送之。
  - 接收端发现该请求的目的端IP地个址是自己，就把自己的以太网地址填进去，
  - 然后交换两个目的端地址和两个发送端地址，以构建ARP应答并返回之*（当然，如前所述，操作字段需要设置为2）*



---

### ARP高速缓存的查看和修改

*通常，ARP维护一个高速缓存，其中包含经常访问（比如网关地址）或最近访问的机器的IP地址到物理地址的映射。这样就避免了重复的ARP请求，提高了发送数据包的速度。*
		Linux下可以使用arp命令来查看和修改ARP高速缓存。

比如，emest-laptop 在某一时刻（注意，ARP 高速缓存是动态变化的）的 ARP缓存内容如下（使用 arp-a 命令）：

> ```shell
> Kongming20 (192.168.1.109) at 08:00:27:53:10:67 [ether] on etho
> ?(192.168.1.1) at 14:e6:e4:93:5b:78 [ether] on etho
> ```
>
> 其中，第一项描述的是另一台测试机 器Kongming20（注意，其IP地址、MAC地址都与图1-8描述的一致 ) 
>
> 第二项描述的是路由器。



下面两条命令则分别删除和添加一个ARP缓存项：
```shell
$ sudo arp -d 192.168.1.109							#删除Kongming20对应的ARP缓存项
$ sudo arp -s 192.168.1.109 08:00:27:53:10:67 		#添加Kongming20 对应的ARP缓存项
```



---

## DNS工作原理

*DNS是一套分布式的域名服务系统*

*每个DNS服务器上都存放着大量的机器名和IP地址的映射, 并且是动态更新的*

*众多网络客户端程序都使用DNS协议来向DNS服务器查询目标主机的IP地址*



### DNS查询和应答报文详解

DNS查询和应答报文的格式如下

![Screenshot_2022-09-03-21-54-15-123_com.miui.gallery](D:\Download\MiShare\Screenshot_2022-09-03-21-54-15-123_com.miui.gallery.png)

*16位标识字段用于标记一对DNS查询和应答，以此区分一个DNS应答是哪个DNS查询的回应*

*16位标志字段用于协商具体的通信方式和反馈通信状态。*



*DNS报文头部的16位标志字段的细节如下图所示。*

![Screenshot_2022-09-03-21-58-28-346_com.miui.gallery](D:\Download\MiShare\Screenshot_2022-09-03-21-58-28-346_com.miui.gallery.png)

- **QR，查询/应答标志。**

  0表示这是一个查询报文，1表示这是一个应答报文。

  

- **opcode，定义查询和应答的类型。**

  0表示标准查询，1表示反向查询（由IP地址获得主机域名），2表示请求服务器状态。

  

- **AA，授权应答标志，仅由应答报文使用。**

  1表示域名服务器是授权服务器。

  

- **TC，截断标志，仅当DNS报文使用UDP服务时使用。**

  *因为UDP数据报有长度限制，所以过长的DNS报文将被截断。*

  1表示DNS报文超过512字节，并被截断。

  

- **RD，递归查询标志。**

  1表示执行递归查询

  ​	*即如果目标DNS服务器无法解析某个主机名，则它将向其他DNS服务器继续查询，如此递归，直到获得结果并把该结果返回给客户端。*

  0表示执行迭代查询

  ​	*即如果目标DNS服务器无法解析某个主机名，则它将自己知道的其他DNS服务器的IP地址返回给客户端，以供客户端参考。*

- **RA，允许递归标志。**

  仅由应答报文使用，1表示DNS服务器支持递归查询。

  

- **zero，这3位未用，必须都设置为0。**

  

- **rcode，4位返回码，表示应答的状态。**

  常用值有0（无错误）和3（域名不存在）。

  

接下来的4个字段则分别指出DNS报文的最后4个字段的资源记录数目。对查询报文而言，它一般包含1个查询问题，而应答资源记录数、授权资源记录数和额外资源记录数则为0。应答报文的应答资源记录数则至少为1，而授权资源记录数和额外资源记录数可为0或非0。



### Linux下访问DNS服务

*我们要访问DNS 服务，就必须先知道DNS服务器的IP 地址。Linux 使用/etc/resolv.conf 文件来存放 DNS 服务器的 IP 地址。*



***Linux下一个常用的访问DNS服务器的客户端程序是host，比如下面的命令是向首选DNS 服务器219.239.26.42查询机器 www.baidu.com的IP地址：***

```shell
$ host -t A www.baidu.com
www.baidu.com is an alias for www.a.shifen.com.			#以下均输出
www.a.shifen.com has address 119.75.217.56
www.a.shifen.com has address 119.75.218.77
```

host命令的输出告诉我们，机器名 www.baidu.com 是 www.a.shifen.com.的别名，并且该机器名对应两个IP 地址

**host命令使用DNS协议和DNS服务器通信，其 -t 选项告诉DNS协议使用哪种查询类型。**

​	*我们这里使用的是A类型，即通过机器的域名获得其IP地址（但实际上返回的资源记录中还包含机器的别名）*

关于 host 命令的详细使用方法，请参考其man手册



---

## socket和TCP / IP协议族的关系

*数据链路层, 网络层, 传输层协议是在内核中实现的, 因此操作系统需要实现一组系统调用, 使得应用程序能够访问这些协议提供的服务*

实现组系统调用的API主要有两套: 

​	**Socket**

​	**XTI**

*XTI现在基本不再使用, 这里只讨论 socket*



由 socket定义的这一组API提供如下两点功能：

- **将应用程序数据从用户缓冲区中复制到TCP/UDP 内核发送缓冲区，以交付内核来发送数据**（比如 send 函数 ) 

  *或者是从内核TCP/UDP接收缓冲区中复制数据到用户缓冲区，以读取数据*

  

- **应用程序可以通过它们来修改内核中各层协议的某些头部信息或其他数据结构，从而精细地控制底层通信的行为**

  *比如可以通过 setsockopt 函数来设置IP数据报在网络上的存活时间*

  

***socket 是一套通用网络编程接口，它不但可以访问内核中TCP/IP协议栈，而且可以访问其他网络协议栈（比如X.25协议栈、UNIX本地域协议栈等）。***

